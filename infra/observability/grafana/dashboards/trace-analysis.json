{
  "_header": {
    "purpose": "Trace analysis dashboard for distributed trace search, service graph, and span-level investigation",
    "scope": "Distributed tracing analysis using Tempo datasource with TraceQL queries and service graph visualization",
    "overview": "Provides trace search and investigation capabilities using the Tempo datasource. Includes trace search by service and duration, duration distribution from Tempo span metrics, service graph visualization using the nodeGraph panel, error rate by span name, and a slowest spans table. Enables drill-down from trace search to individual span waterfall views. Span metrics (traces_spanmetrics_*) are generated by Tempo metrics generator and stored in Mimir.",
    "dependencies": "Tempo datasource (uid: tempo) for trace queries, Mimir datasource (uid: mimir) for span metrics, Tempo metrics generator enabled in tempo.yml",
    "exports": "Provisioned Grafana dashboard accessible at /grafana/d/trace-analysis",
    "interfaces": "TraceQL queries against Tempo, PromQL queries against Tempo-generated span metrics in Mimir",
    "environment": "Identical across dev/staging/prod",
    "related": "home.json for navigation, backend-red-method.json for metric exemplar links to traces, profiling.json for trace-to-profile correlation",
    "implementation": "Grafana dashboard JSON schema version 39 with Tempo and Mimir datasource queries, nodeGraph for service map"
  },
  "uid": "trace-analysis",
  "title": "Trace Analysis",
  "description": "Distributed trace search, service graph, and span analysis",
  "tags": ["tracing", "tempo", "distributed-tracing", "service-graph"],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 1,
  "editable": false,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "links": [
    {
      "title": "Home",
      "url": "/grafana/d/home",
      "type": "link",
      "icon": "external link"
    },
    {
      "title": "Backend RED",
      "url": "/grafana/d/backend-red-method",
      "type": "link",
      "icon": "external link"
    },
    {
      "title": "Profiling",
      "url": "/grafana/d/profiling",
      "type": "link",
      "icon": "external link"
    }
  ],
  "templating": {
    "list": [
      {
        "name": "service",
        "label": "Service",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "mimir" },
        "query": "label_values(traces_spanmetrics_calls_total, service)",
        "includeAll": true,
        "allValue": ".*",
        "multi": false,
        "refresh": 2,
        "sort": 1
      }
    ]
  },
  "panels": [
    {
      "type": "row",
      "title": "Trace Search",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "id": 1,
      "collapsed": false
    },
    {
      "type": "traces",
      "title": "Recent Traces",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 1 },
      "id": 2,
      "datasource": { "type": "tempo", "uid": "tempo" },
      "targets": [
        {
          "queryType": "nativeSearch",
          "serviceName": "${service}",
          "limit": 20,
          "refId": "A"
        }
      ],
      "options": {}
    },
    {
      "type": "row",
      "title": "Duration Distribution",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 11 },
      "id": 3,
      "collapsed": false
    },
    {
      "type": "timeseries",
      "title": "Span Duration p50/p95/p99 (from Span Metrics)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
      "id": 4,
      "datasource": { "type": "prometheus", "uid": "mimir" },
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum(rate(traces_spanmetrics_latency_bucket{service=~\"$service\"}[$__rate_interval])) by (le))",
          "legendFormat": "p50",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(traces_spanmetrics_latency_bucket{service=~\"$service\"}[$__rate_interval])) by (le))",
          "legendFormat": "p95",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(traces_spanmetrics_latency_bucket{service=~\"$service\"}[$__rate_interval])) by (le))",
          "legendFormat": "p99",
          "refId": "C"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 10
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "max"] }
      }
    },
    {
      "type": "timeseries",
      "title": "Span Call Rate (from Span Metrics)",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
      "id": 5,
      "datasource": { "type": "prometheus", "uid": "mimir" },
      "targets": [
        {
          "expr": "sum(rate(traces_spanmetrics_calls_total{service=~\"$service\"}[$__rate_interval])) by (span_name)",
          "legendFormat": "{{span_name}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 50,
            "stacking": { "mode": "normal" }
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "max"] }
      }
    },
    {
      "type": "row",
      "title": "Service Graph",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 20 },
      "id": 6,
      "collapsed": false
    },
    {
      "type": "nodeGraph",
      "title": "Service Dependency Graph",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 21 },
      "id": 7,
      "datasource": { "type": "prometheus", "uid": "mimir" },
      "targets": [
        {
          "expr": "sum(rate(traces_service_graph_request_total[$__rate_interval])) by (client, server)",
          "format": "table",
          "instant": true,
          "refId": "edges"
        },
        {
          "expr": "sum(rate(traces_service_graph_request_total[$__rate_interval])) by (server)",
          "format": "table",
          "instant": true,
          "refId": "nodes"
        }
      ],
      "options": {
        "nodes": {
          "mainStatUnit": "ops"
        },
        "edges": {
          "mainStatUnit": "ops"
        }
      }
    },
    {
      "type": "row",
      "title": "Error Analysis",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 31 },
      "id": 8,
      "collapsed": false
    },
    {
      "type": "timeseries",
      "title": "Error Rate by Span Name",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 32 },
      "id": 9,
      "datasource": { "type": "prometheus", "uid": "mimir" },
      "targets": [
        {
          "expr": "sum(rate(traces_spanmetrics_calls_total{service=~\"$service\", status_code=\"STATUS_CODE_ERROR\"}[$__rate_interval])) by (span_name)",
          "legendFormat": "{{span_name}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 50
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 0.1 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "max"] }
      }
    },
    {
      "type": "timeseries",
      "title": "Error Rate % by Service",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 32 },
      "id": 10,
      "datasource": { "type": "prometheus", "uid": "mimir" },
      "targets": [
        {
          "expr": "sum(rate(traces_spanmetrics_calls_total{service=~\"$service\", status_code=\"STATUS_CODE_ERROR\"}[$__rate_interval])) / sum(rate(traces_spanmetrics_calls_total{service=~\"$service\"}[$__rate_interval])) * 100",
          "legendFormat": "Error %",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 10
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 5 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "single" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      }
    },
    {
      "type": "row",
      "title": "Slowest Spans",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 40 },
      "id": 11,
      "collapsed": false
    },
    {
      "type": "table",
      "title": "Slowest Span Types (p99)",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 41 },
      "id": 12,
      "datasource": { "type": "prometheus", "uid": "mimir" },
      "targets": [
        {
          "expr": "topk(10, histogram_quantile(0.99, sum(rate(traces_spanmetrics_latency_bucket{service=~\"$service\"}[$__rate_interval])) by (le, span_name)))",
          "format": "table",
          "instant": true,
          "refId": "A"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": { "Time": true },
            "renameByName": {
              "span_name": "Span Name",
              "Value": "p99 Duration (s)"
            }
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s"
        },
        "overrides": []
      },
      "options": {
        "showHeader": true,
        "sortBy": [{ "displayName": "p99 Duration (s)", "desc": true }]
      }
    }
  ],
  "time": { "from": "now-1h", "to": "now" },
  "refresh": "30s"
}
