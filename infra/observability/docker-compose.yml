# Purpose: Docker Compose orchestration for the Grafana observability stack on EC2
# Scope: Eight-service observability stack (Grafana, Mimir, Loki, Tempo, Pyroscope, Alloy, node-exporter, cAdvisor) with memory limits
# Overview: Defines the complete Grafana observability stack as Docker Compose services running on a single
#     EC2 t3.medium instance (4GB RAM). Services are organized with health checks and dependency ordering:
#     storage backends (Mimir, Loki, Tempo, Pyroscope) start first, infrastructure exporters (node-exporter,
#     cAdvisor) start in parallel, then the collector (Alloy) and visualization layer (Grafana).
#     Total memory allocation is ~2.9GB leaving headroom for the OS.
#     All services communicate over a shared Docker bridge network using service names as hostnames.
#     Bind mounts persist data across container restarts; long-term storage uses S3 via instance profile credentials.
#     Storage backends run as non-root (UID 10001) with bind-mounted data directories owned by the same UID.
# Dependencies: Docker Engine, Docker Compose plugin, config files mounted from /opt/observability/
# Exports: Grafana UI (3001), Alloy OTLP gRPC (4317), Alloy OTLP HTTP (4318), Alloy Faro (12347), Pyroscope (4040)
# Interfaces: ALB routes /collect/* to port 12347; Grafana accessed only via SSM tunnel; ECS pushes OTLP to 4317/4318
# Environment: Identical configuration across dev/staging/prod; S3 bucket name baked into component configs
# Related: Component configs in grafana/, mimir/, loki/, tempo/, pyroscope/, alloy/ subdirectories
# Implementation: Memory-constrained deployment with health check dependencies and bind mounts for local caching

services:
  mimir:
    image: grafana/mimir:2.14.0
    container_name: mimir
    restart: unless-stopped
    volumes:
      - ./mimir/mimir.yml:/etc/mimir/mimir.yml:ro
      - ./data/mimir:/data/mimir
    command: ["-config.file=/etc/mimir/mimir.yml"]
    deploy:
      resources:
        limits:
          memory: 768M

  loki:
    image: grafana/loki:3.3.2
    container_name: loki
    restart: unless-stopped
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - ./data/loki:/data/loki
    command: ["-config.file=/etc/loki/loki.yml"]
    deploy:
      resources:
        limits:
          memory: 384M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 45s

  tempo:
    image: grafana/tempo:2.6.1
    container_name: tempo
    restart: unless-stopped
    volumes:
      - ./tempo/tempo.yml:/etc/tempo/tempo.yml:ro
      - ./data/tempo:/data/tempo
    command: ["-config.file=/etc/tempo/tempo.yml"]
    deploy:
      resources:
        limits:
          memory: 384M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3200/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 45s

  pyroscope:
    image: grafana/pyroscope:1.10.0
    container_name: pyroscope
    restart: unless-stopped
    ports:
      - "4040:4040"
    volumes:
      - ./pyroscope/pyroscope.yml:/etc/pyroscope/config.yaml:ro
      - ./data/pyroscope:/data/pyroscope
    deploy:
      resources:
        limits:
          memory: 384M

  node-exporter:
    image: prom/node-exporter:v1.8.2
    container_name: node-exporter
    restart: unless-stopped
    pid: host
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/rootfs"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    deploy:
      resources:
        limits:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9100/metrics"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: cadvisor
    restart: unless-stopped
    devices:
      - /dev/kmsg:/dev/kmsg
    security_opt:
      - no-new-privileges:true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    command:
      - "--housekeeping_interval=30s"
      - "--docker_only=true"
      - "--store_container_labels=false"
    deploy:
      resources:
        limits:
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  alloy:
    image: grafana/alloy:v1.13.0
    container_name: alloy
    restart: unless-stopped
    ports:
      - "4317:4317"
      - "4318:4318"
      - "12347:12347"
    volumes:
      - ./alloy/config.alloy:/etc/alloy/config.alloy:ro
    command: ["run", "/etc/alloy/config.alloy", "--server.http.listen-addr=0.0.0.0:12345"]
    deploy:
      resources:
        limits:
          memory: 384M
    depends_on:
      mimir:
        condition: service_started
      loki:
        condition: service_healthy
      tempo:
        condition: service_healthy
      pyroscope:
        condition: service_started
      node-exporter:
        condition: service_healthy
      cadvisor:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/12345"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  grafana:
    image: grafana/grafana-oss:11.4.0
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/dashboard-provisioning.yml:/etc/grafana/provisioning/dashboards/dashboard-provisioning.yml:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    deploy:
      resources:
        limits:
          memory: 384M
    depends_on:
      mimir:
        condition: service_started
      loki:
        condition: service_healthy
      tempo:
        condition: service_healthy
      pyroscope:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3001/grafana/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  grafana-data:
