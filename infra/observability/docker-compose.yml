# Purpose: Docker Compose orchestration for the Grafana observability stack on EC2
# Scope: Six-service observability stack (Grafana, Mimir, Loki, Tempo, Pyroscope, Alloy) with memory limits
# Overview: Defines the complete Grafana observability stack as Docker Compose services running on a single
#     EC2 t3.medium instance (4GB RAM). Services are organized with health checks and dependency ordering:
#     storage backends (Mimir, Loki, Tempo, Pyroscope) start first, then the collector (Alloy) and
#     visualization layer (Grafana). Total memory allocation is ~2.7GB leaving headroom for the OS.
#     All services communicate over a shared Docker bridge network using service names as hostnames.
#     Data volumes persist across container restarts; long-term storage uses S3 via instance profile credentials.
# Dependencies: Docker Engine, Docker Compose plugin, config files mounted from /opt/observability/
# Exports: Grafana UI (3001), Alloy OTLP gRPC (4317), Alloy OTLP HTTP (4318), Alloy Faro (12347), Pyroscope (4040)
# Interfaces: ALB routes /grafana/* to port 3001, /collect/* to port 12347; ECS pushes OTLP to 4317/4318
# Environment: Identical configuration across dev/staging/prod; S3 bucket name baked into component configs
# Related: Component configs in grafana/, mimir/, loki/, tempo/, pyroscope/, alloy/ subdirectories
# Implementation: Memory-constrained deployment with health check dependencies and named volumes for local caching

services:
  mimir:
    image: grafana/mimir:2.14.0
    container_name: mimir
    restart: unless-stopped
    volumes:
      - ./mimir/mimir.yml:/etc/mimir/mimir.yml:ro
      - mimir-data:/data/mimir
    command: ["-config.file=/etc/mimir/mimir.yml"]
    deploy:
      resources:
        limits:
          memory: 768M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9009/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 45s

  loki:
    image: grafana/loki:3.3.2
    container_name: loki
    restart: unless-stopped
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - loki-data:/data/loki
    command: ["-config.file=/etc/loki/loki.yml"]
    deploy:
      resources:
        limits:
          memory: 384M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 45s

  tempo:
    image: grafana/tempo:2.6.1
    container_name: tempo
    restart: unless-stopped
    volumes:
      - ./tempo/tempo.yml:/etc/tempo/tempo.yml:ro
      - tempo-data:/data/tempo
    command: ["-config.file=/etc/tempo/tempo.yml"]
    deploy:
      resources:
        limits:
          memory: 384M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3200/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 45s

  pyroscope:
    image: grafana/pyroscope:1.10.0
    container_name: pyroscope
    restart: unless-stopped
    ports:
      - "4040:4040"
    volumes:
      - ./pyroscope/pyroscope.yml:/etc/pyroscope/config.yaml:ro
      - pyroscope-data:/data/pyroscope
    deploy:
      resources:
        limits:
          memory: 384M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4040/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 45s

  alloy:
    image: grafana/alloy:1.5.1
    container_name: alloy
    restart: unless-stopped
    ports:
      - "4317:4317"
      - "4318:4318"
      - "12347:12347"
    volumes:
      - ./alloy/config.alloy:/etc/alloy/config.alloy:ro
    command: ["run", "/etc/alloy/config.alloy", "--server.http.listen-addr=0.0.0.0:12345"]
    deploy:
      resources:
        limits:
          memory: 384M
    depends_on:
      mimir:
        condition: service_healthy
      loki:
        condition: service_healthy
      tempo:
        condition: service_healthy
      pyroscope:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:12345/-/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  grafana:
    image: grafana/grafana-oss:11.4.0
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./grafana/dashboard-provisioning.yml:/etc/grafana/provisioning/dashboards/dashboard-provisioning.yml:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    deploy:
      resources:
        limits:
          memory: 384M
    depends_on:
      mimir:
        condition: service_healthy
      loki:
        condition: service_healthy
      tempo:
        condition: service_healthy
      pyroscope:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3001/grafana/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  grafana-data:
  mimir-data:
  loki-data:
  tempo-data:
  pyroscope-data:
