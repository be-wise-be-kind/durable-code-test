name: Infrastructure Down

on:
  schedule:
    # 10 PM PST = 6 AM UTC (standard time reference)
    # Runs every day to tear down infrastructure nightly for cost savings
    # Note: During PDT (daylight saving), this runs at 11 PM PDT
    - cron: '0 6 * * *'  # Daily 6 AM UTC (10 PM PST / 11 PM PDT)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to teardown'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
      scope:
        description: 'Infrastructure scope to teardown'
        required: true
        default: 'runtime'
        type: choice
        options:
          - runtime
          - all
      dry_run:
        description: 'Dry run (plan only, no destroy)'
        required: false
        default: false
        type: boolean

jobs:
  down:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Setup tfenv
        run: |
          git clone --depth=1 https://github.com/tfutils/tfenv.git ~/.tfenv
          echo "$HOME/.tfenv/bin" >> $GITHUB_PATH

      - name: Install Terraform
        run: |
          tfenv install 1.9.8
          tfenv use 1.9.8

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHub-Actions-Down-${{ github.run_id }}
          aws-region: us-west-2

      - name: Verify AWS credentials
        run: |
          echo "ğŸ” Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS credentials verified"

      - name: Check infrastructure status (before)
        env:
          ENV: ${{ inputs.environment || 'dev' }}
          AWS_PROFILE: ""
        run: |
          echo "ğŸ“Š Infrastructure status before teardown:"
          just infra status || echo "Status check failed - continuing with teardown"

      - name: Initialize Terraform
        env:
          ENV: ${{ inputs.environment || 'dev' }}
          AWS_PROFILE: ""
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          SCOPE="${{ inputs.scope || 'runtime' }}"
          just infra init "$SCOPE"
          echo "âœ… Terraform initialized"

      - name: Plan infrastructure teardown
        if: ${{ inputs.dry_run == true }}
        env:
          ENV: ${{ inputs.environment || 'dev' }}
          AWS_PROFILE: ""
        run: |
          echo "ğŸ” Planning infrastructure teardown (dry run)..."
          echo "Note: Terraform destroy does not support separate plan output."
          echo "Showing current state instead:"
          just infra status

      - name: Execute infrastructure teardown
        if: ${{ inputs.dry_run != true }}
        env:
          ENV: ${{ inputs.environment || 'dev' }}
          AWS_PROFILE: ""
        run: |
          echo "ğŸ”¥ Executing infrastructure teardown..."
          SCOPE="${{ inputs.scope || 'runtime' }}"

          # In CI, don't use AWS_PROFILE - OIDC sets environment variables directly
          # Add confirmation for base/all scope destruction
          if [[ "$SCOPE" == "all" ]]; then
            echo "âš ï¸ Destroying all infrastructure"
            just infra down "$SCOPE" destroy-all
          elif [[ "$SCOPE" == "base" ]]; then
            echo "âš ï¸ Destroying base infrastructure"
            just infra down "$SCOPE" destroy-base
          else
            echo "Destroying runtime infrastructure"
            just infra down "$SCOPE"
          fi

      - name: Check infrastructure status (after)
        if: ${{ inputs.dry_run != true }}
        env:
          ENV: ${{ inputs.environment || 'dev' }}
          AWS_PROFILE: ""
        run: |
          echo "ğŸ“Š Infrastructure status after teardown:"
          just infra status || echo "Status check completed"

      - name: Calculate cost savings
        if: ${{ inputs.dry_run != true }}
        run: |
          ENV="${{ inputs.environment || 'dev' }}"
          SCOPE="${{ inputs.scope || 'runtime' }}"

          echo "ğŸ’° Estimated cost savings:"
          if [[ "$SCOPE" == "runtime" ]]; then
            echo "  - Runtime teardown: ~\$2.10/day savings (~\$63/month)"
            echo "  - Destroyed: NAT Gateway, ALB, ECS services"
            echo "  - Preserved: VPC, ECR, certificates (free/low-cost)"
          elif [[ "$SCOPE" == "all" ]]; then
            echo "  - Complete teardown: ~\$2.50/day savings"
            echo "  - Note: Full rebuild takes longer (certificates, etc.)"
          fi

      - name: Post teardown summary
        if: always()
        run: |
          echo "ğŸ¯ Infrastructure Down Summary"
          echo "  Environment: ${{ inputs.environment || 'dev' }}"
          echo "  Scope: ${{ inputs.scope || 'runtime' }}"
          echo "  Dry Run: ${{ inputs.dry_run || 'false' }}"
          echo "  Status: ${{ job.status }}"
          echo ""
          echo "ğŸ’¡ To restore infrastructure:"
          echo "  - Manual: Run the 'Infrastructure Up' workflow"
          echo "  - CLI: just infra up ${{ inputs.scope || 'runtime' }} true"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Infrastructure down failed!"
          echo "ğŸ”§ Manual intervention may be required"
          echo "ğŸ“ Check AWS console and Terraform state"
          echo "ğŸš¨ Consider manual teardown if automation continues to fail"