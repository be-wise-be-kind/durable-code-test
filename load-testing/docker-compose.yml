# Purpose: Docker Compose orchestration for Locust load testing service
# Scope: Single-service configuration for running Locust against deployed web instances
# Overview: Defines the locust-master service that runs the Locust load testing framework
#     with a web UI on port 8089. Targets external URLs (deployed web instances) configured
#     via the LOCUST_HOST environment variable, which defaults to the LOAD_TEST_HOST value
#     from the project .env file or can be overridden at runtime. Volume-mounts locustfiles,
#     lib shared utility package, and profiles directory for live editing during test
#     development. Supports mixed HTTP+WebSocket scenarios with configurable weight ratios
#     via HTTP_WEIGHT and WS_WEIGHT environment variables. Workers are deferred to a later PR.
# Dependencies: Docker Compose, Dockerfile in same directory, LOAD_TEST_HOST env var
# Exports: Locust master service with web UI
# Interfaces: Port 8089 (Locust web UI), LOCUST_HOST env var for target URL
# Environment: Local Docker runtime, targeting deployed web instances
# Related: Dockerfile for image build, locustfiles/ for test scenarios, lib/ for shared utilities,
#     profiles/ for YAML load profiles
# Implementation: Single master service with volume mounts for locustfiles, lib, and profiles;
#     env-based host config and weight ratio configuration

services:
  locust-master:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: durable-code-locust-master
    ports:
      - "8089:8089"
    environment:
      - LOCUST_HOST=${LOAD_TEST_HOST:-http://localhost:8000}
      # Default: mixed HTTP+WebSocket scenarios. Override for single-protocol testing:
      #   LOCUST_LOCUSTFILE=locustfiles/http_users.py       (HTTP only)
      #   LOCUST_LOCUSTFILE=locustfiles/websocket_users.py  (WebSocket only)
      - LOCUST_LOCUSTFILE=locustfiles/mixed_users.py
      # Weight ratio for mixed scenarios (HTTP vs WebSocket user distribution)
      - HTTP_WEIGHT=${HTTP_WEIGHT:-70}
      - WS_WEIGHT=${WS_WEIGHT:-30}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./locustfiles:/load-testing/locustfiles
      - ./lib:/load-testing/lib
      - ./profiles:/load-testing/profiles
    command: []
