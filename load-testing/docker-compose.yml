# Purpose: Docker Compose orchestration for Locust load testing services
# Scope: Multi-service configuration for HTTP/WebSocket and browser-based load testing
# Overview: Defines the locust-master service for HTTP/WebSocket load testing with a web UI on
#     port 8089, and the locust-browser service for Playwright-based browser load testing on
#     port 8090. The locust-master targets external URLs configured via LOCUST_HOST. The
#     locust-browser service uses the browser Docker Compose profile so it only starts when
#     explicitly requested (--profile browser), keeping default builds lightweight. Both services
#     volume-mount locustfiles, lib, and profiles for live editing during test development.
#     Supports mixed HTTP+WebSocket scenarios with configurable weight ratios via HTTP_WEIGHT
#     and WS_WEIGHT environment variables.
# Dependencies: Docker Compose, Dockerfile and Dockerfile.browser, LOAD_TEST_HOST env var
# Exports: Locust master service (HTTP/WS) and locust-browser service (Playwright)
# Interfaces: Port 8089 (HTTP/WS Locust UI), Port 8090 (Browser Locust UI), LOCUST_HOST and
#     LOAD_TEST_FRONTEND_HOST env vars for target URLs
# Environment: Local Docker runtime, targeting deployed web instances
# Related: Dockerfile for HTTP/WS image, Dockerfile.browser for Playwright image, locustfiles/
#     for test scenarios, lib/ for shared utilities, profiles/ for YAML load profiles
# Implementation: Two services with profile-based separation; browser service uses Docker Compose
#     profiles to avoid building ~400MB Playwright image by default

services:
  locust-master:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: durable-code-locust-master
    ports:
      - "8089:8089"
    environment:
      - LOCUST_HOST=${LOAD_TEST_HOST:-http://localhost:8000}
      # Default: mixed HTTP+WebSocket scenarios. Override for single-protocol testing:
      #   LOCUST_LOCUSTFILE=locustfiles/http_users.py       (HTTP only)
      #   LOCUST_LOCUSTFILE=locustfiles/websocket_users.py  (WebSocket only)
      - LOCUST_LOCUSTFILE=locustfiles/mixed_users.py
      # Weight ratio for mixed scenarios (HTTP vs WebSocket user distribution)
      - HTTP_WEIGHT=${HTTP_WEIGHT:-70}
      - WS_WEIGHT=${WS_WEIGHT:-30}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./locustfiles:/load-testing/locustfiles
      - ./lib:/load-testing/lib
      - ./profiles:/load-testing/profiles
    command: []

  locust-browser:
    build:
      context: .
      dockerfile: Dockerfile.browser
    container_name: durable-code-locust-browser
    profiles:
      - browser
    ports:
      - "8090:8089"
    environment:
      - LOCUST_HOST=${LOAD_TEST_HOST:-http://localhost:8000}
      - LOCUST_LOCUSTFILE=locustfiles/browser_users.py
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - LOAD_TEST_FRONTEND_HOST=${LOAD_TEST_FRONTEND_HOST:-http://host.docker.internal:5173}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./locustfiles:/load-testing/locustfiles
      - ./lib:/load-testing/lib
    command: []
